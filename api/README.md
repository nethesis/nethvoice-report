# Queries

Each query is saved in the filesystem on a specific path based on where the query results are to be displayed. All charts and tables are generated from a query named:
```
/opt/nethvoice-report/api/queries/<report>/<section>/<view>/<n>_<graph_type>_<name>.<query_type>
```
where:
- **report**: is the reference to *queue* or *cdr & cost* report
- **section**: is the macro section of the reports. Type: *alphanumeric* (*dashboard*, *data*, *performance*, *distribution*, *graphs*)
- **view**: is the sub-section of macro section. Type: *alphanumeric* (*agent*, *hour*, *geo*, *area*)
- **n**: is the position or order of the chart or table. Type *number*
- **graph_type**: it defines the type of the report. Type: *table*, *pie*, *bar*, *line*
- **name**: is the name of the report. Type *alphanumeric*
- **query_type**: it defines the type of the report data. Type *sql* or *rrd*

Each query result has a particular syntax that is a convention between APIs and UI useful to format well the reports.

## Table charts

SQL queries can generate table charts with one, two or three header layers. Header layers are useful to organize and group related columns.
A SQL query that generate a table chart must output column names that follow this syntax:
```
<top_header>$<middle_header>$<column_name>£<type>#^<pivot>
```
where:
- **top_header**$: it defines the text on the first header layer. Used only if the table has three header layers
- **middle_header**$: it defines the text on the second header layer. Used only if the table has two header layers
- **column_name**: it defines the name of the column that must be internationalized
- **type**: it defines the type of column data and how it should be formatted. Types: *num*, *seconds*, *label*, *year*, *month*, *week*, *day*, *hour*
- **#**: if present, the column is initially collapsed. A button to expand it is provided on its super-header
- **pivot** if present, coloumn data on the various rows of the table are transformed into a set of columns. A pivot column generates a table with two header layers. If **pivotGroup** is used instead of **pivot** column data are considered as time data in the format HH:mm and organized in a header layer with the various hours of the day; a table with three header layers is generated. See [Distribution/Hourly queries](https://github.com/nethesis/nethvoice-report/tree/master/root/opt/nethvoice-report/api/queries/distribution/hourly) for examples


# Views
Each query execution is based on precalculated data generated by night tasks, called *Views* that are materialized tables. All views are saved on filesystem under:
```
/opt/nethvoice-report/api/views/<section>_<view>.sql
```

# Values
Each value within the filters in the user interface is obtained from pre-calculated values ​​generated by night tasks. All value are saved on filesystem under:
```
/opt/nethvoice-report/api/values/<filter_name>.sql
```

# Templates
To reduce the numbers of record inside the `cdr`table, the templates query split `cdr` table in more, smaller table divided by year or month. The new name is:
- `cdr_YYYY`: contains all calls for a specific year
- `cdr_YYYY-MM`: contains all calls for a specific month of a year
```
/opt/nethvoice-report/api/values/cdr_<name>.sql
```

# API
- `POST` `/api/login`

  Used to login (authenticate) the user

  **Body request**
  ```json
  {
    "username": "username",
    "password": "password"
  }
  ```
  **Body response**
   ```json
  {
    "code":200,
    "expire":"2020-09-17T11:55:40+02:00",
    "token":"zzzAAAbbbIUzI1NiIsInR5cCI6IkpXVCJ9.zzzAAAbbb2MDAzMzY1NDAsImlkIjoiYWRtaW4iLCJvcmlnX2lhdCI6MTYwMDMzMjk0MCwicXVldWVzIjpbIjQwMiIsIjQwMyJdfQ.zzzAAAbbbXqJeUVhKsMlqckvS_gvV_C5HIZxNV8"
  }
  ```

- `POST` `/api/logout`

  Used to logout the user

  **Header request**
  ```json
  Authorization: <Bearer your_JWT_token>
  Content-Type: application/json
   ```
  **Body request**
  ```json
  {}
  ```
  **Body response**
  ```json
  {
    "code":200
  }
  ```

- `GET` `/api/refresh_token`

  Used to refresh JWT token before expiration

  **Header request**
  ```json
  Authorization: Bearer <your_JWT_token>
  Content-Type: application/json
  ```
  **Body request**
   ```json
  {}
  ```
  **Body response**
  ```json
  {
    "code":200,
    "expire":"2020-09-17T11:55:40+02:00",
    "token":"zzzAAAbbbIUzI1NiIsInR5cCI6IkpXVCJ9.zzzAAAbbb2MDAzMzY1NDAsImlkIjoiYWRtaW4iLCJvcmlnX2lhdCI6MTYwMDMzMjk0MCwicXVldWVzIjpbIjQwMiIsIjQwMyJdfQ.zzzAAAbbbXqJeUVhKsMlqckvS_gvV_C5HIZxNV8"
  }
  ```

- `GET` `/api/graph/:report/:section/:view`

  Used to execute a specific query for a particular section and view and report

  **Header request**
  ```
  Authorization: Bearer your_JWT_token
  Content-Type: application/json
    ```
  **URL params**
  ```
  ?filter={json_encoded_filter}
  ?graph=query_name_of_the_graph
  ```
  **Body response**
  ```json
  [
    ["col1", "col2", "col3"],
    ["val1", "val2", "val3"],
    ...
    ["valX", "valY", "valZ"]
  ]
  ```

- `GET` `/api/searches`

  Used to retrieve all user's custom searches

  **Header request**
  ```
  Authorization: Bearer your_JWT_token
  Content-Type: application/json
  ```
  **Body request**
  ```json
  {}
  ```
  **Body response**
  ```json
  {
   "searches":[
      {
         "name":"search_name",
         "section":"data",
         "view":"agent",
         "filter":{
            "queues":null,
            "groups":null,
            "time":{
               "time_range":"day",
               "value":"monday"
            },
            "name":"company_name",
            "agent":"agent_name",
            "nullCall":true
         }
      }
    ]
  }
  ```

- `POST` `/api/searches`

  Used to save a custom search

  **Header request**
  ```
  Authorization: Bearer your_JWT_token
  Content-Type: application/json
  ```
  **Body request**
  ```json
  {
    "name": "check",
    "section": "data",
    "view": "agent",
    "filter": {
      "queue": "401",
      "time": {
        "time_range": "day",
        "value": "monday"
      },
      "name": "Edoardo",
      "agent": "5555",
      "null_call": true
    }
  }
  ```
  **Body response**
  ```json
  {
    "message": "search saved successfully"
  }
  ```

- `DELETE` `/api/searches/:search_id`

  Used to save a custom search

  **Header request**
  ```
  Authorization: Bearer your_JWT_token
  Content-Type: application/json
  ```
  **Body request**
  ```json
  {}
  ```
  **Body response**
  ```json
  {
    "message": "search deleted successfully"
  }
  ```

- `GET` `/api/filters`

  Used to retrieve default filter or override filters

  **Header request**
  ```
  Authorization: Bearer your_JWT_token
  Content-Type: application/json
  ```
  **Body request**
  ```json
  {}
  ```
  **Body response**
  ```json
  {
   "filter":{
      "queues":null,
      "groups":null,
      "time":{
         "time_range":"day",
         "value":"monday"
      },
      "name":"Edoardo Override",
      "agent":"5555 override",
      "nullCall":true
    }
  }
  ```

- `GET` `/api/authorizations`

  Used to retrieve all user's authorizations

  **Header request**
  ```
  Authorization: Bearer your_JWT_token
  Content-Type: application/json
  ```
  **Body request**
  ```json
  {}
  ```
  **Body response**
  ```json
  {
    "authorizations": {
      "username": "X",
      "queues": [
        "4444",
        "4443"
      ],
      "groups": [
        "development",
        "support",
        "marketing"
      ],
      "agents": [
        "Michele",
        "Scatolini"
      ]
    }
  }
  ```

- `GET` `/api/phonebook`

  Used to retrieve all saved numbers in phonebook

  **Header request**
  ```
  Authorization: Bearer your_JWT_token
  Content-Type: application/json
  ```
  **Body request**
  ```json
  {}
  ```
  **Body response**
  ```json
  {
    "Contact Name One": {
      "homephones": [
        ""
      ],
      "workphones": [
        "00395558888777"
      ],
      "cellphones": [
        ""
      ]
    },
    "Contact Name Two": {
      "homephones": [
        ""
      ],
      "workphones": [
        "00395558222444"
      ],
      "cellphones": [
        ""
      ]
    },
    ...
  }
  ```

- `GET` `/api/settings`

  Used to retrieve all admin settings

  **Header request**
  ```
  Authorization: Bearer your_JWT_token (only admin or X user)
  Content-Type: application/json
  ```
  **Body request**
  ```json
  {}
  ```
  **Body response**
  ```json
  {
    "settings": {
      "start_hour": "10:00",
      "end_hour": "18:00"
    }
  }
  ```

- `PUT` `/api/settings`

  Used to update admins settings

  **Header request**
  ```
  Authorization: Bearer your_JWT_token (only admin or X user)
  Content-Type: application/json
  ```
  **Body request**
  ```json
  {
    "start_hour": "10:00",
    "end_hour": "18:00"
  }
  ```
  **Body response**
  ```json
  {
    "message": "settings updated successfully"
  }
  ```

- `GET` `/api/query_tree`

  Used to retrieve all queries saved in file system

  **Header request**
  ```
  Authorization: Bearer your_JWT_token (only admin or X user)
  Content-Type: application/json
  ```
  **Body request**
  ```json
  {}
  ```
  **Body response**
  ```json
  {
    "query_tree": {
      "dashboard": {
        "default": [
          "graph_call_distribution_per_queue",
          "zone_comune_provincia_regione"
        ]
      },
      "data": {
        "agent": [
          "graph_call_distribution_per_queue",
          "other_query",
          "query"
        ],
        "call": [
          "query"
        ],
        "caller": [
          "query"
        ],
        "ivr": [
          "query"
        ],
        "session": [
          "query"
        ],
        "summary": [
          "query"
        ],
        "test": [
          "queryyy"
        ]
      },
      "distribution": {
        "geographic": [
          "query"
        ],
        "hourly": [
          "query"
        ]
      },
      "graphs": {
        "agent": [
          "query"
        ],
        "area": [
          "query"
        ],
        "avg_duration": [
          "query"
        ],
        "avg_wait": [
          "query"
        ],
        "hour": [
          "query"
        ],
        "load": [
          "query"
        ],
        "queue_position": [
          "query"
        ]
      },
      "performance": {
        "default": [
          "query"
        ]
      }
    }
  }
  ```
